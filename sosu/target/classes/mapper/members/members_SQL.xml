<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="members">
   
   <!-- 회원가입 -->
   <insert id="join">
   <![CDATA[
       INSERT INTO MEMBER 
          (M_IDX, M_NAME, M_GENDER, M_NICKNAME, M_EMAIL, M_PW, M_PHONE, M_JUMIN,
          M_TYPE, M_DEL_YN, M_REGDATE, M_QUE, M_ANS, M_PRIVATE, M_BAN_DATE)
      VALUES 
         (M_IDX.NEXTVAL, #{M_NAME}, #{M_GENDER}, #{M_NICKNAME}, #{M_EMAIL},#{M_PW},
         #{M_PHONE}, #{M_JUMIN}, default, default, SYSDATE, #{M_QUE}, #{M_ANS}, default, null)
    ]]>
   </insert>

   <!-- 로그인 -->
   <select id="login" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
      SELECT *
      FROM MEMBER
      WHERE M_EMAIL = #{M_EMAIL} AND M_PW = #{M_PW} AND M_DEL_YN!='Y' AND M_TYPE='M'
    ]]>
   </select>
   
   <!-- ID 중복 확인 -->
   <select id="checkId" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT COUNT(1)
         FROM MEMBER
         WHERE M_EMAIL=#{M_EMAIL} AND M_DEL_YN!='Y'
    ]]>
   </select>
   
   <!-- ID 찾기 -->
   <select id="findId" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT M_EMAIL
         FROM MEMBER
         WHERE M_NAME=#{M_NAME} AND M_PHONE=#{M_PHONE} AND M_QUE=#{M_QUE} AND M_ANS=#{M_ANS}
    ]]>
   </select>
   
   <!-- PW 찾기 -->
   <select id="findPw" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT M_PW
         FROM MEMBER
         WHERE M_NAME=#{M_NAME} AND M_EMAIL=#{M_EMAIL} AND M_JUMIN=#{M_JUMIN}
    ]]>
   </select>
   
   <!-- 마이페이지 : 내 정보 수정 -->
   <update id="mypageModify" parameterType="hashmap">
      <![CDATA[
         UPDATE MEMBER
         SET M_NICKNAME=#{M_NICKNAME}, M_PW=#{M_PW}, M_PHONE=#{M_PHONE}, M_QUE=#{M_QUE}, M_ANS=#{M_ANS}
      WHERE M_IDX=#{M_IDX}
    ]]>
   </update>
   
   <!-- 마이페이지 : 회원 탈퇴 처리 -->
   <update id="mypageDelete" parameterType="hashmap">
      <![CDATA[
       UPDATE MEMBER SET M_DEL_YN='Y', M_GENDER=0, M_NAME=' ', M_NICKNAME=' ', M_EMAIL=' ', M_PW=' ', M_PHONE=' ', M_JUMIN=' ', M_QUE=' ', M_ANS=' '
      WHERE M_IDX=#{M_IDX}
    ]]>
   </update>   
   
   <!-- 마이페이지 : 닉네임, 이메일 가져오기 -->
   <select id="mypageNE" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT M_NICKNAME, M_EMAIL
         FROM MEMBER
         WHERE M_IDX=#{M_IDX}
    ]]>
   </select>
   
   <!-- 마이페이지 : 개설한 모임에 대한 별점 평균 (소숫점 출력) -->
   <select id="mypageStarFloat" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT ROUND(AVG(RV_STAR),1)
      FROM MOIM M, REVIEW R 
      WHERE M.M_IDX=#{M_IDX} AND RV_MO_IDX=M.MO_IDX
    ]]>
   </select>
   
   <!-- 마이페이지 : 개설한 모임에 대한 별점 평균 (정수로 반올림) -->
   <select id="mypageStarInt" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
       SELECT ROUND(AVG(RV_STAR))
      FROM MOIM M, REVIEW R 
      WHERE M.M_IDX=#{M_IDX} AND RV_MO_IDX=M.MO_IDX
    ]]>
   </select>
   
   <!-- 마이페이지 : 개설한 모임 개수 -->
   <select id="mypageOpenMoimCount" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT COUNT(*) FROM MOIM WHERE M_IDX=#{M_IDX}
    ]]>
   </select>
   
   <!-- 마이페이지 : 개설한 모임 상세 내용 -->
   <select id="mypageOpenMoim" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
      SELECT MO_TITLE, MO_DETAILREGION, MO_DETAILCATEGORY, MO_COST, MO_MAXPEOPLE,MO_IDX
      FROM MOIM
      WHERE M_IDX=#{M_IDX}
      ORDER BY MO_REGDATE DESC
    ]]>
   </select>
   
   <!-- 마이페이지 : 개설한 모임에 대한 현재 인원 -->
   <select id="mypageMoimMember" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT COUNT(*) 
      FROM PARTYMEM 
      WHERE MO_IDX=#{MO_IDX} AND P_BAN_YN='N' AND P_FINAL_YN='Y'
    ]]>
   </select>
   
   <!-- 마이페이지 : 참여한 모임 개수 -->
   <select id="mypagePartyMoimCount" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT COUNT(*) 
         FROM PARTYMEM P, MOIM M
      WHERE P.M_IDX=#{M_IDX} AND P.P_BAN_YN='N' AND P.P_FINAL_YN='Y' AND P.MO_IDX=M.MO_IDX
    ]]>
   </select>
   
   <!-- 마이페이지 : 참여한 모임 상세 내용 -->
   <select id="mypagePartyMoim" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT M.MO_TITLE, M.MO_DETAILREGION, M.MO_DETAILCATEGORY, M.MO_COST, M.MO_MAXPEOPLE, MEM.M_PRIVATE
      FROM PARTYMEM P, MOIM M, MEMBER MEM
      WHERE P.M_IDX=#{M_IDX} AND P.P_BAN_YN='N' AND P.P_FINAL_YN='Y' AND P.MO_IDX=M.MO_IDX AND P.M_IDX=MEM.M_IDX
      ORDER BY M.MO_REGDATE DESC
    ]]>
   </select>
   
   <!-- 마이페이지 : 내가 남긴 리뷰 개수 -->
   <select id="mypageMyReviewCount" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT COUNT(*)
      FROM PARTYMEM P, MOIM M, REVIEW R
      WHERE R.RV_M_IDX=#{M_IDX} AND P.P_BAN_YN='N'AND P.P_FINAL_YN='Y' AND M.MO_IDX = R.RV_MO_IDX AND P.M_IDX=R.RV_M_IDX AND M.MO_IDX=P.MO_IDX
    ]]>
   </select>
   
   <!-- 마이페이지 : 나에게 남긴 리뷰 개수 -->
   <select id="mypageToMeReviewCount" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
       SELECT COUNT(*)
      FROM MOIM M, REVIEW R
      WHERE M.M_IDX=#{M_IDX} AND M.MO_IDX=R.RV_MO_IDX
    ]]>
   </select>
   
   <!-- 마이페이지 : 내가 남긴 리뷰 상세 내용 -->
   <select id="mypageMyReview" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT M.MO_TITLE, M.MO_REGDATE, R.RV_STAR, R.RV_CONTENT, R.RV_M_IDX
      FROM PARTYMEM P, MOIM M, REVIEW R
      WHERE R.RV_M_IDX=#{M_IDX} AND P.P_BAN_YN='N'AND P.P_FINAL_YN='Y' AND M.MO_IDX = R.RV_MO_IDX AND P.M_IDX=R.RV_M_IDX AND M.MO_IDX=P.MO_IDX
      ORDER BY R.RV_REGDATE DESC
   ]]>
   </select>
   
   <!-- 마이페이지 : 나에게 남긴 리뷰 상세 내용 -->
   <select id="mypageToMeReview" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
       SELECT M.MO_TITLE, M.MO_REGDATE, R.RV_STAR, R.RV_CONTENT, R.RV_M_IDX
      FROM MOIM M, REVIEW R
      WHERE M.M_IDX=#{M_IDX} AND M.MO_IDX=R.RV_MO_IDX
      ORDER BY R.RV_REGDATE DESC
    ]]>
   </select>
   
   <!-- 마이페이지 : 모임 찜 개수 -->
   <select id="mypageZzimMoimCount" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
       SELECT COUNT(*)
      FROM ZZIM Z, MOIM M
      WHERE Z.M_IDX=#{M_IDX} AND Z.Z_TABLE='M' AND Z.Z_ARTICLE=M.MO_IDX
    ]]>
   </select>
   
   <!-- 마이페이지 : 자유게시판 찜 개수 -->
   <select id="mypageZzimFreeCount" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
       SELECT COUNT(*)
      FROM ZZIM Z, FREE F
      WHERE Z.M_IDX=#{M_IDX} AND Z.Z_TABLE='F' AND Z.Z_ARTICLE=F.FR_IDX
      ORDER BY F.FR_REGDATE DESC
    ]]>
   </select>
   
   <!-- 마이페이지 : 모임 찜 -->
   <select id="mypageZzimMoim" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
       SELECT Z.Z_IDX, Z.M_IDX, Z.Z_ARTICLE, Z.Z_TABLE, M.MO_IDX, M.MO_TITLE, M.MO_DETAILCATEGORY, M.MO_DETAILREGION, M.MO_COST, MEM.M_PRIVATE
      FROM ZZIM Z, MOIM M, MEMBER MEM
      WHERE Z.M_IDX=#{M_IDX} AND Z.Z_TABLE='M' AND Z.Z_ARTICLE=M.MO_IDX AND Z.M_IDX=MEM.M_IDX
      ORDER BY M.MO_REGDATE DESC
    ]]>
   </select>
   
   <!-- 마이페이지 : 자유게시판 찜 -->
   <select id="mypageZzimFree" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
       SELECT Z.Z_IDX, Z.M_IDX, Z.Z_ARTICLE, Z.Z_TABLE, F.FR_IDX, F.FR_TITLE, F.FR_CATEGORY, F.FR_REGDATE, F.FR_WRITER, F.FR_COUNT, M.M_PRIVATE
      FROM ZZIM Z, FREE F, MEMBER M
      WHERE Z.M_IDX=#{M_IDX} AND Z.Z_TABLE='F' AND Z.Z_ARTICLE=F.FR_IDX AND Z.M_IDX=M.M_IDX
    ]]>
   </select>
   
   <!-- 마이페이지 : 다른 회원에게 비공개 처리 -->
   <update id="mypagePrivate" parameterType="hashmap">
      <![CDATA[
       UPDATE MEMBER SET M_PRIVATE=#{M_PRIVATE}
      WHERE M_IDX=#{M_IDX}
    ]]>
   </update>
   
   <!-- 관리자 로그인 -->
   <select id="adminLogin" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT *
         FROM MEMBER
         WHERE M_EMAIL=#{M_EMAIL} AND M_PW = #{M_PW} AND M_DEL_YN='N' AND M_TYPE='A'
    ]]>
   </select>
         
   <!-- 관리자 : 회원 리스트 -->
   <!-- <select id="adminMemberList" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
         SELECT M_IDX, M_NAME, M_EMAIL, M_PHONE, M_TYPE, M_DEL_YN, M_BAN_DATE, R_COUNT
      FROM MEMBER, REPORT
      WHERE M_IDX = R_REPORTEDMEM
      AND
      ORDER BY R_COUNT DESC
    ]]>
   </select> -->
   
   <!-- 관리자 : 회원 정지 처리 -->
   <update id="adminMemberStop" parameterType="hashmap">
      <![CDATA[
       UPDATE MEMBER SET M_DEL_YN='S', M_BAN_DATE=SYSDATE
      WHERE M_IDX=#{M_IDX}
    ]]>
   </update>
   
   <!-- 관리자 : 회원 정지 취소 -->
   <update id="adminMemberStopCancle" parameterType="hashmap">
      <![CDATA[
       UPDATE MEMBER SET M_DEL_YN='N', M_BAN_DATE=NULL
      WHERE M_IDX=#{M_IDX}
    ]]>
   </update>
   
   <!-- 관리자 : 회원 상세보기 -->
   <!-- <select id="adminMemberDetail" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
       SELECT M_IDX, M_NAME, M_GENDER, M_NICKNAME, M_EMAIL, M_PHONE, M_JUMIN, M_TYPE, M_DEL_YN, M_REGDATE, M_BAN_DATE,
      R_MEM, R_REASON, R_COUNT, R_DATE, R_DETAIL, R_DEL_YN
      FROM MEMBER, REPORT
      WHERE M_IDX = R_REPORTEDMEM AND M_IDX=#{M_IDX}
    ]]>
   </select> -->
   
   <!-- 관리자 : 신고 내역 삭제 -->
   <!-- <update id="adminMemberDetail" parameterType="hashmap">
      <![CDATA[
       
    ]]>
   </update> -->
   
   <!-- 신고하기 -->
   <!-- <insert id="profileRegister" parameterType="hashmap">
      INSERT INTO REPORT (R_IDX, R_MEM, R_REASON, R_REPORTEDMEM, R_COUNT, R_DATE, R_DETAIL, R_DEL_YN)
      VALUES (R_IDX.NEXTVAL, #{R_MEM}, #{R_REASON}, #{M_IDX}, 1, SYSDATE, #{R_DETAIL}, 'N')
   </insert> -->
   
   <!-- 사진 이미지 가져오기 : 프로필, 모임, 자유게시판, 리뷰 등 메인 사진 -->
   <select id="profileGet" resultType="hashmap" parameterType="hashmap">
      <![CDATA[
       SELECT *
      FROM FILE_T
      WHERE F_TABLE=#{F_TABLE} AND F_ARTICLE=#{F_ARTICLE} AND F_MAIN_YN='Y'
    ]]>
   </select>
   
   <!-- 프로필 사진 기본 이미지 등록하기 -->
   <insert id="profileRegister" parameterType="hashmap" useGeneratedKeys="true" keyProperty="M_IDX">
      <selectKey keyProperty="F_IDX" order="BEFORE" resultType="hashmap">
         SELECT F_IDX.NEXTVAL FROM DUAL
      </selectKey>
      INSERT INTO FILE_T(F_IDX, F_TABLE, F_ARTICLE, F_OGNAME, F_SVNAME, F_SIZE, F_MAIN_YN, F_DEL_YN, F_REG_DATE)
      VALUES (#{F_IDX}, 'P', #{M_IDX}, #{F_OGNAME}, #{F_SVNAME}, #{F_SIZE}, 'Y', 'N', SYSDATE)
   </insert>
   
   <!-- 프로필 수정, 삭제 -->
   <update id="profileUpdate" parameterType="hashmap">
      <![CDATA[
       UPDATE FILE_T
       SET F_OGNAME=#{F_OGNAME}, F_SVNAME=#{F_SVNAME}, F_SIZE=#{F_SIZE}, F_REG_DATE=SYSDATE
      WHERE F_ARTICLE=#{M_IDX} AND F_TABLE='P' AND F_MAIN_YN='Y'
    ]]>
   </update>
   
   
      



</mapper>